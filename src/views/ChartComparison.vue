<template>
  <div class="demo-page">
    <header class="page-header">
      <h1>ğŸ“Š å›¾è¡¨æ‰“å°æ•ˆæœå¯¹æ¯”</h1>
      <router-link to="/" class="back-link">â† è¿”å›é¦–é¡µ</router-link>
    </header>

    <div class="content-wrapper">
      <aside class="info-panel">
        <h2>æµ‹è¯•è¯´æ˜</h2>

        <div class="info-section warning">
          <h3>âš ï¸ å·²çŸ¥é—®é¢˜</h3>
          <ul>
            <li><strong>vue3-print-nb</strong>: å›¾è¡¨å³ä¾§å¯èƒ½è¢«è£å‰ª</li>
            <li><strong>html2pdf.js</strong>: Gridå¸ƒå±€æ”¯æŒå·®</li>
            <li><strong>html2canvas</strong>: Canvaså¤„ç†å¯èƒ½é‡å </li>
          </ul>
        </div>

        <div class="info-section success">
          <h3>âœ… æ¨èæ–¹æ¡ˆ</h3>
          <ul>
            <li><strong>jsPDF</strong>: ç²¾ç¡®åæ ‡æ§åˆ¶</li>
            <li><strong>pdfmake</strong>: å£°æ˜å¼å¸ƒå±€</li>
            <li><strong>åŸç”Ÿæ‰“å°</strong>: æ•ˆæœç¨³å®š</li>
          </ul>
        </div>

        <div class="info-section">
          <h3>ğŸ“‹ æµ‹è¯•å›¾è¡¨</h3>
          <p>æœ¬é¡µåŒ…å«8ä¸ªæµ‹è¯•å›¾è¡¨ï¼š</p>
          <ul>
            <li>æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾</li>
            <li>é¢ç§¯å›¾ã€å †å æŸ±çŠ¶å›¾</li>
            <li>æ•£ç‚¹å›¾ã€é›·è¾¾å›¾ã€æ··åˆå›¾</li>
          </ul>
          <p style="margin-top: 10px; font-weight: bold">æ‰“å°å¸ƒå±€ï¼šæ¯è¡Œ2ä¸ªå›¾è¡¨</p>
        </div>
      </aside>

      <main class="demo-panel">
        <!-- æµ‹è¯•å›¾è¡¨é¢„è§ˆåŒº -->
        <section class="chart-preview-section">
          <h2>ğŸ“ˆ æµ‹è¯•å›¾è¡¨é¢„è§ˆï¼ˆ8ä¸ªå›¾è¡¨ - æ‰“å°æ—¶æ¯è¡Œ2ä¸ªï¼‰</h2>
          <div class="chart-grid">
            <div class="chart-item">
              <div ref="chart1Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[0]?.title }}</p>
            </div>
            <div class="chart-item">
              <div ref="chart2Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[1]?.title }}</p>
            </div>
            <div class="chart-item">
              <div ref="chart3Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[2]?.title }}</p>
            </div>
            <div class="chart-item">
              <div ref="chart4Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[3]?.title }}</p>
            </div>
            <div class="chart-item">
              <div ref="chart5Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[4]?.title }}</p>
            </div>
            <div class="chart-item">
              <div ref="chart6Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[5]?.title }}</p>
            </div>
            <div class="chart-item">
              <div ref="chart7Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[6]?.title }}</p>
            </div>
            <div class="chart-item">
              <div ref="chart8Ref" class="chart-container"></div>
              <p class="chart-label">{{ chartOptions[7]?.title }}</p>
            </div>
          </div>
        </section>

        <!-- æ¡†æ¶æ‰“å°æŒ‰é’®åŒº -->
        <section class="framework-buttons">
          <h2>ğŸ–¨ï¸ é€‰æ‹©æ¡†æ¶æ‰“å°æµ‹è¯•</h2>
          <p class="button-desc">
            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œä½¿ç”¨å¯¹åº”æ¡†æ¶æ‰“å°8ä¸ªå›¾è¡¨ï¼ˆæ¯è¡Œ2åˆ—ç½‘æ ¼å¸ƒå±€ï¼‰- æŸ¥çœ‹å“ªä¸ªæ¡†æ¶èƒ½æ­£ç¡®æ˜¾ç¤º
          </p>

          <div class="button-grid">
            <button @click="printWithNative" class="fw-btn native" :disabled="loading">
              <span class="fw-icon">ğŸŒ</span>
              <span class="fw-name">åŸç”Ÿæ‰“å°</span>
              <span class="fw-size">0KB</span>
            </button>
            <button @click="printWithPrintJs" class="fw-btn printjs" :disabled="loading">
              <span class="fw-icon">âš¡</span>
              <span class="fw-name">Print.js</span>
              <span class="fw-size">~18KB</span>
            </button>
            <button @click="printWithVuePrint" class="fw-btn vueprint" :disabled="loading">
              <span class="fw-icon">ğŸ’š</span>
              <span class="fw-name">vue3-print-nb</span>
              <span class="fw-size">~15KB</span>
            </button>
            <button @click="printWithJsPDF" class="fw-btn jspdf" :disabled="loading">
              <span class="fw-icon">ğŸ“„</span>
              <span class="fw-name">jsPDF</span>
              <span class="fw-size">~150KB</span>
            </button>
            <button @click="printWithPdfmake" class="fw-btn pdfmake" :disabled="loading">
              <span class="fw-icon">ğŸ“‹</span>
              <span class="fw-name">pdfmake</span>
              <span class="fw-size">~600KB</span>
            </button>
            <button @click="printWithHtml2Canvas" class="fw-btn html2canvas" :disabled="loading">
              <span class="fw-icon">ğŸ–¼ï¸</span>
              <span class="fw-name">html2canvas</span>
              <span class="fw-size">~180KB</span>
            </button>
            <button @click="printWithHtml2Pdf" class="fw-btn html2pdf" :disabled="loading">
              <span class="fw-icon">ğŸ”„</span>
              <span class="fw-name">html2pdf.js</span>
              <span class="fw-size">~330KB</span>
            </button>
            <button @click="printWithPdfLib" class="fw-btn pdflib" :disabled="loading">
              <span class="fw-icon">ğŸ“š</span>
              <span class="fw-name">PDF-LIB</span>
              <span class="fw-size">~200KB</span>
            </button>
            <button
              @click="printWithPrintHtmlElement"
              class="fw-btn printhtmlelement"
              :disabled="loading"
            >
              <span class="fw-icon">ğŸ¯</span>
              <span class="fw-name">print-html-element</span>
              <span class="fw-size">~5KB</span>
            </button>
          </div>

          <div v-if="loading" class="loading-status">â³ {{ loadingMessage }}</div>
        </section>

        <!-- éšè—çš„æ‰“å°å†…å®¹åŒºï¼ˆä¾›Print.jsä½¿ç”¨ï¼‰ -->
        <div id="print-content-area" ref="printContentRef" class="print-content-hidden">
          <div class="print-header">
            <h1>å›¾è¡¨æ‰“å°æ•ˆæœæµ‹è¯•æŠ¥å‘Šï¼ˆ2åˆ—å¸ƒå±€ï¼‰</h1>
            <p>æµ‹è¯•æ—¶é—´ï¼š{{ currentDate }} | æµ‹è¯•æ¡†æ¶ï¼š{{ currentFramework }}</p>
          </div>
          <div class="chart-grid">
            <div v-for="(chart, index) in chartOptions" :key="index" class="chart-item">
              <h4>{{ index + 1 }}. {{ chart.title }}</h4>
              <img v-if="chartImages[index]" :src="chartImages[index]" :alt="chart.title" />
            </div>
          </div>
          <div class="print-footer">
            <p>
              å‰ç«¯æ‰“å°æ¡†æ¶è°ƒç ”æŠ¥å‘Š - å›¾è¡¨å¯¹æ¯”æµ‹è¯• |
              æµ‹è¯•é‡ç‚¹ï¼šæ£€æŸ¥æ¯è¡Œ2ä¸ªå›¾è¡¨çš„ç½‘æ ¼å¸ƒå±€æ˜¯å¦æ­£ç¡®ï¼Œæœ‰æ— é‡å æˆ–æ¢è¡Œé”™è¯¯
            </p>
          </div>
        </div>
      </main>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, nextTick } from 'vue'
import * as echarts from 'echarts'
import type { ECharts } from 'echarts'
import printJS from 'print-js'
import html2canvas from 'html2canvas'
import html2pdf from 'html2pdf.js'
import { printElement } from 'print-html-element'
import { createChineseJsPDF } from '../utils/fontLoader'
import pdfMake from 'pdfmake/build/pdfmake'
import pdfFonts from 'pdfmake/build/vfs_fonts'
import { PDFDocument } from 'pdf-lib'
// @ts-ignore
pdfMake.vfs = pdfFonts.pdfMake ? pdfFonts.pdfMake.vfs : pdfFonts.vfs

// å›¾è¡¨refs
const chart1Ref = ref<HTMLDivElement>()
const chart2Ref = ref<HTMLDivElement>()
const chart3Ref = ref<HTMLDivElement>()
const chart4Ref = ref<HTMLDivElement>()
const chart5Ref = ref<HTMLDivElement>()
const chart6Ref = ref<HTMLDivElement>()
const chart7Ref = ref<HTMLDivElement>()
const chart8Ref = ref<HTMLDivElement>()

// æ‰“å°åŒºåŸŸref
const printContentRef = ref<HTMLDivElement>()

// å›¾è¡¨å®ä¾‹
const chartInstances: (ECharts | null)[] = [null, null, null, null, null, null, null, null]

// çŠ¶æ€
const loading = ref(false)
const loadingMessage = ref('')
const currentDate = ref(new Date().toLocaleDateString('zh-CN'))
const currentFramework = ref('æœªé€‰æ‹©')

// å›¾è¡¨å›¾ç‰‡æ•°æ®
const chartImages = ref<string[]>(['', '', '', '', '', '', '', ''])

// 8ä¸ªæµ‹è¯•å›¾è¡¨é…ç½®
const chartOptions = [
  {
    title: 'æŠ˜çº¿å›¾-é”€å”®è¶‹åŠ¿',
    option: {
      title: { text: 'æœˆåº¦é”€å”®è¶‹åŠ¿', left: 'center', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'axis' },
      grid: { left: '12%', right: '8%', bottom: '15%', top: '25%' },
      xAxis: {
        type: 'category',
        data: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'],
        axisLabel: { fontSize: 10 },
      },
      yAxis: { type: 'value', name: 'ä¸‡å…ƒ', axisLabel: { fontSize: 10 } },
      series: [
        {
          data: [120, 200, 150, 80, 170, 210],
          type: 'line',
          smooth: true,
          itemStyle: { color: '#667eea' },
          areaStyle: { color: 'rgba(102, 126, 234, 0.2)' },
        },
      ],
    },
  },
  {
    title: 'æŸ±çŠ¶å›¾-äº§å“é”€é‡',
    option: {
      title: { text: 'äº§å“é”€é‡å¯¹æ¯”', left: 'center', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'axis' },
      grid: { left: '12%', right: '8%', bottom: '15%', top: '25%' },
      xAxis: { type: 'category', data: ['äº§å“A', 'B', 'C', 'D', 'E'], axisLabel: { fontSize: 10 } },
      yAxis: { type: 'value', name: 'ä»¶', axisLabel: { fontSize: 10 } },
      series: [
        {
          data: [320, 280, 450, 380, 520],
          type: 'bar',
          itemStyle: { color: '#764ba2' },
          barWidth: '45%',
        },
      ],
    },
  },
  {
    title: 'é¥¼å›¾-åŒºåŸŸå æ¯”',
    option: {
      title: { text: 'åŒºåŸŸé”€å”®å æ¯”', left: 'center', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'item', formatter: '{b}: {d}%' },
      legend: { orient: 'vertical', right: '5%', top: 'center', textStyle: { fontSize: 10 } },
      series: [
        {
          type: 'pie',
          radius: ['35%', '60%'],
          center: ['35%', '55%'],
          data: [
            { value: 335, name: 'åä¸œ' },
            { value: 310, name: 'åå—' },
            { value: 234, name: 'ååŒ—' },
            { value: 135, name: 'è¥¿å—' },
          ],
          label: { fontSize: 10 },
          itemStyle: {
            color: (p: any) => ['#667eea', '#764ba2', '#f093fb', '#f5576c'][p.dataIndex],
          },
        },
      ],
    },
  },
  {
    title: 'é¢ç§¯å›¾-è®¿é—®é‡',
    option: {
      title: { text: 'ç½‘ç«™è®¿é—®é‡', left: 'center', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'axis' },
      grid: { left: '12%', right: '8%', bottom: '15%', top: '25%' },
      xAxis: {
        type: 'category',
        data: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'],
        axisLabel: { fontSize: 10 },
      },
      yAxis: { type: 'value', name: 'PV', axisLabel: { fontSize: 10 } },
      series: [
        {
          data: [1200, 1500, 1800, 2100, 2400],
          type: 'line',
          smooth: true,
          areaStyle: { color: 'rgba(72, 187, 120, 0.3)' },
          itemStyle: { color: '#48bb78' },
        },
      ],
    },
  },
  {
    title: 'å †å æŸ±çŠ¶å›¾-å¯¹æ¯”',
    option: {
      title: { text: 'å­£åº¦å¯¹æ¯”', left: 'center', top: '2%', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'axis' },
      legend: { data: ['Q1', 'Q2'], top: '12%', textStyle: { fontSize: 10 } },
      grid: { left: '12%', right: '8%', bottom: '15%', top: '32%' },
      xAxis: { type: 'category', data: ['å›¢é˜ŸA', 'B', 'C'], axisLabel: { fontSize: 10 } },
      yAxis: { type: 'value', axisLabel: { fontSize: 10 } },
      series: [
        { name: 'Q1', type: 'bar', data: [120, 132, 101], itemStyle: { color: '#f5576c' } },
        { name: 'Q2', type: 'bar', data: [220, 182, 191], itemStyle: { color: '#4facfe' } },
      ],
    },
  },
  {
    title: 'æ•£ç‚¹å›¾-åˆ†å¸ƒ',
    option: {
      title: { text: 'æ•°æ®åˆ†å¸ƒ', left: 'center', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'item' },
      grid: { left: '12%', right: '8%', bottom: '15%', top: '25%' },
      xAxis: { type: 'value', axisLabel: { fontSize: 10 } },
      yAxis: { type: 'value', axisLabel: { fontSize: 10 } },
      series: [
        {
          type: 'scatter',
          data: [
            [10, 20],
            [15, 30],
            [20, 25],
            [25, 40],
            [30, 35],
            [35, 50],
            [40, 45],
          ],
          itemStyle: { color: '#667eea' },
          symbolSize: 12,
        },
      ],
    },
  },
  {
    title: 'é›·è¾¾å›¾-èƒ½åŠ›',
    option: {
      title: { text: 'èƒ½åŠ›è¯„ä¼°', left: 'center', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'item' },
      radar: {
        indicator: [
          { name: 'é€Ÿåº¦', max: 100 },
          { name: 'è´¨é‡', max: 100 },
          { name: 'æˆæœ¬', max: 100 },
          { name: 'ä½“éªŒ', max: 100 },
        ],
        center: ['50%', '60%'],
        radius: '55%',
        axisName: { fontSize: 10 },
      },
      series: [
        {
          type: 'radar',
          data: [{ value: [80, 90, 70, 85], name: 'äº§å“A', itemStyle: { color: '#764ba2' } }],
        },
      ],
    },
  },
  {
    title: 'æ··åˆå›¾è¡¨-ç»¼åˆ',
    option: {
      title: { text: 'é”€é‡ä¸åˆ©æ¶¦', left: 'center', top: '2%', textStyle: { fontSize: 13 } },
      tooltip: { trigger: 'axis' },
      legend: { data: ['é”€é‡', 'åˆ©æ¶¦'], top: '12%', textStyle: { fontSize: 10 } },
      grid: { left: '12%', right: '12%', bottom: '15%', top: '32%' },
      xAxis: { type: 'category', data: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ'], axisLabel: { fontSize: 10 } },
      yAxis: [
        { type: 'value', name: 'é”€é‡', axisLabel: { fontSize: 10 } },
        { type: 'value', name: 'åˆ©æ¶¦ç‡', axisLabel: { fontSize: 10, formatter: '{value}%' } },
      ],
      series: [
        { name: 'é”€é‡', type: 'bar', data: [200, 230, 210, 250], itemStyle: { color: '#667eea' } },
        {
          name: 'åˆ©æ¶¦',
          type: 'line',
          yAxisIndex: 1,
          data: [15, 18, 16, 20],
          itemStyle: { color: '#f5576c' },
        },
      ],
    },
  },
]

// åˆå§‹åŒ–å›¾è¡¨
const initCharts = () => {
  const refs = [
    chart1Ref,
    chart2Ref,
    chart3Ref,
    chart4Ref,
    chart5Ref,
    chart6Ref,
    chart7Ref,
    chart8Ref,
  ]
  refs.forEach((ref, index) => {
    if (ref.value && chartOptions[index]) {
      chartInstances[index] = echarts.init(ref.value)
      // @ts-ignore
      chartInstances[index]!.setOption(chartOptions[index].option)
    }
  })
}

// å¯¼å‡ºå›¾è¡¨ä¸ºå›¾ç‰‡
const exportChartImages = () => {
  chartInstances.forEach((chart, index) => {
    if (chart) {
      chartImages.value[index] = chart.getDataURL({ type: 'png', pixelRatio: 2 })
    }
  })
}

onMounted(() => {
  initCharts()
})

// ==================== æ‰“å°è¾…åŠ©å‡½æ•° ====================

// æ‰“å¼€æ‰“å°é¢„è§ˆçª—å£
const openPrintPreview = (blob: Blob) => {
  const url = URL.createObjectURL(blob)
  const printWindow = window.open(url, '_blank')
  if (printWindow) {
    printWindow.onload = () => {
      setTimeout(() => {
        printWindow.print()
      }, 500)
    }
  }
}

// æ‰“å¼€iframeæ‰“å°é¢„è§ˆ
const openIframePrint = (blob: Blob) => {
  const url = URL.createObjectURL(blob)
  const iframe = document.createElement('iframe')
  iframe.style.position = 'fixed'
  iframe.style.right = '0'
  iframe.style.bottom = '0'
  iframe.style.width = '0'
  iframe.style.height = '0'
  iframe.style.border = 'none'
  iframe.src = url
  document.body.appendChild(iframe)

  iframe.onload = () => {
    setTimeout(() => {
      iframe.contentWindow?.print()
    }, 500)

    const cleanup = () => {
      setTimeout(() => {
        document.body.removeChild(iframe)
        URL.revokeObjectURL(url)
      }, 1000)
    }

    iframe.contentWindow?.addEventListener('afterprint', cleanup)
    // 5åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†
    setTimeout(cleanup, 300000)
  }
}

// ç”Ÿæˆæ‰“å°HTMLå†…å®¹ï¼ˆæ¯è¡Œ2åˆ—ç½‘æ ¼å¸ƒå±€ï¼‰
const generatePrintHTML = (frameworkName: string) => {
  exportChartImages()

  // ç”Ÿæˆå›¾è¡¨HTML
  const chartsHTML = chartOptions
    .map(
      (chart, index) => `
    <div class="chart-item">
      <h4>${index + 1}. ${chart.title}</h4>
      <img src="${chartImages.value[index]}" alt="${chart.title}">
    </div>
  `,
    )
    .join('')

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>å›¾è¡¨æ‰“å°æµ‹è¯• - ${frameworkName}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: 'Microsoft YaHei', sans-serif;
          padding: 15mm;
          background: white;
        }
        .header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 12px;
          border-bottom: 2px solid #667eea;
        }
        .header h1 { font-size: 20px; color: #2d3748; margin-bottom: 6px; }
        .header p { font-size: 11px; color: #718096; }

        .chart-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15mm;
          margin-bottom: 15px;
        }

        .chart-item {
          page-break-inside: avoid;
          background: #f9fafb;
          padding: 10px;
          border-radius: 6px;
          border: 1px solid #e2e8f0;
        }

        .chart-item h4 {
          font-size: 12px;
          color: #2d3748;
          margin-bottom: 8px;
          text-align: center;
        }

        .chart-item img {
          width: 100%;
          height: auto;
          border-radius: 4px;
          display: block;
        }

        .footer {
          text-align: center;
          margin-top: 20px;
          padding-top: 12px;
          border-top: 1px solid #e2e8f0;
          font-size: 9px;
          color: #a0aec0;
        }

        @media print {
          body { padding: 10mm; }
          .chart-grid { gap: 10mm; }
          .chart-item {
            page-break-inside: avoid;
            break-inside: avoid;
          }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>å›¾è¡¨æ‰“å°æ•ˆæœæµ‹è¯•æŠ¥å‘Šï¼ˆ2åˆ—å¸ƒå±€ï¼‰</h1>
        <p>æµ‹è¯•æ—¶é—´ï¼š${currentDate.value} | æµ‹è¯•æ¡†æ¶ï¼š${frameworkName}</p>
      </div>
      <div class="chart-grid">
        ${chartsHTML}
      </div>
      <div class="footer">
        <p>å‰ç«¯æ‰“å°æ¡†æ¶è°ƒç ”æŠ¥å‘Š - å›¾è¡¨å¯¹æ¯”æµ‹è¯• | æµ‹è¯•é‡ç‚¹ï¼šæ£€æŸ¥æ¯è¡Œ2ä¸ªå›¾è¡¨çš„ç½‘æ ¼å¸ƒå±€æ˜¯å¦æ­£ç¡®ï¼Œæœ‰æ— é‡å æˆ–æ¢è¡Œé”™è¯¯</p>
      </div>
    </body>
    </html>
  `
}

// ==================== 9ä¸ªæ¡†æ¶çš„æ‰“å°å®ç° ====================

// 1. åŸç”Ÿæ‰“å°
const printWithNative = async () => {
  currentFramework.value = 'åŸç”Ÿæ‰“å° (window.print)'
  loading.value = true
  loadingMessage.value = 'å‡†å¤‡æ‰“å°å†…å®¹...'

  try {
    const html = generatePrintHTML('åŸç”Ÿæ‰“å°')
    const blob = new Blob([html], { type: 'text/html' })
    openIframePrint(blob)
  } finally {
    loading.value = false
  }
}

// 2. Print.js
const printWithPrintJs = async () => {
  currentFramework.value = 'Print.js'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨Print.jsæ‰“å°...'

  try {
    exportChartImages()
    await nextTick()

    // æ›´æ–°æ‰“å°åŒºå†…å®¹
    if (printContentRef.value) {
      printJS({
        printable: 'print-content-area',
        type: 'html',
        css: [],
        scanStyles: true,
        style: `
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { font-family: 'Microsoft YaHei', sans-serif; padding: 15mm; }
          .print-header { text-align: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #667eea; }
          .print-header h1 { font-size: 20px; color: #2d3748; }
          .print-header p { font-size: 11px; color: #718096; }
          .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15mm; margin-bottom: 15px; }
          .chart-item { page-break-inside: avoid; background: #f9fafb; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; }
          .chart-item h4 { font-size: 12px; margin-bottom: 8px; text-align: center; }
          .chart-item img { max-width: 100%; height: auto; display: block; border-radius: 4px; }
          .print-footer { text-align: center; margin-top: 20px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 9px; color: #a0aec0; }
          @media print {
            body { padding: 10mm; }
            .chart-grid { gap: 10mm; }
            .chart-item { break-inside: avoid; }
          }
        `,
      })
    }
  } finally {
    setTimeout(() => {
      loading.value = false
    }, 500)
  }
}

// 3. vue3-print-nb (ä½¿ç”¨åŸç”Ÿæ–¹å¼æ¨¡æ‹Ÿ)
const printWithVuePrint = async () => {
  currentFramework.value = 'vue3-print-nb'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨vue3-print-nbæ‰“å°...'

  try {
    const html = generatePrintHTML('vue3-print-nb')
    const blob = new Blob([html], { type: 'text/html' })
    openIframePrint(blob)
  } finally {
    loading.value = false
  }
}

// 4. jsPDF
const printWithJsPDF = async () => {
  currentFramework.value = 'jsPDF'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨jsPDFç”ŸæˆPDF...'

  try {
    exportChartImages()
    const doc = await createChineseJsPDF()

    doc.setFont('SourceHanSansSC', 'normal', 400)

    // æ ‡é¢˜
    doc.setFontSize(16)
    doc.text('å›¾è¡¨æ‰“å°æ•ˆæœæµ‹è¯• (2åˆ—å¸ƒå±€)', 105, 15, { align: 'center' })

    doc.setFontSize(9)
    doc.setTextColor(100)
    doc.text(`æµ‹è¯•æ—¶é—´: ${currentDate.value} | æµ‹è¯•æ¡†æ¶: jsPDF`, 105, 22, { align: 'center' })

    doc.setDrawColor(102, 126, 234)
    doc.setLineWidth(0.5)
    doc.line(15, 26, 195, 26)

    doc.setTextColor(0)
    let y = 35
    const imgWidth = 85
    const imgHeight = 60
    const leftX = 15
    const rightX = 110
    const gap = 20

    // æ¯è¡Œ2ä¸ªå›¾è¡¨ï¼ˆæ¯é¡µæœ€å¤š3è¡Œ=6ä¸ªå›¾è¡¨ï¼‰
    for (let i = 0; i < chartImages.value.length; i += 2) {
      // å·¦ä¾§å›¾è¡¨
      doc.setFontSize(10)
      if (chartOptions[i]) {
        // @ts-ignore
        doc.text(`${i + 1}. ${chartOptions[i].title}`, leftX, y)
      }
      if (chartImages.value[i]) {
        doc.addImage(chartImages.value[i]!, 'PNG', leftX, y + 2, imgWidth, imgHeight)
      }

      // å³ä¾§å›¾è¡¨
      if (i + 1 < chartImages.value.length) {
        if (chartOptions[i + 1]) {
          // @ts-ignore
          doc.text(`${i + 2}. ${chartOptions[i + 1].title}`, rightX, y)
        }
        if (chartImages.value[i + 1]) {
          doc.addImage(chartImages.value[i + 1]!, 'PNG', rightX, y + 2, imgWidth, imgHeight)
        }
      }

      y += imgHeight + gap

      // æ¢é¡µæ£€æŸ¥ï¼ˆy > 200è¡¨ç¤ºå·²ç»æ”¾äº†3è¡Œï¼Œéœ€è¦æ¢é¡µï¼‰
      if (y > 200 && i + 2 < chartImages.value.length) {
        doc.addPage()
        y = 20
      }
    }

    // é¡µè„š
    doc.setFontSize(8)
    doc.text('å‰ç«¯æ‰“å°æ¡†æ¶è°ƒç ”æŠ¥å‘Š - å›¾è¡¨å¯¹æ¯”æµ‹è¯•', 105, 285, { align: 'center' })

    const pdfBlob = doc.output('blob')
    openPrintPreview(pdfBlob)
  } catch (error) {
    console.error('jsPDF error:', error)
    alert('jsPDFç”Ÿæˆå¤±è´¥: ' + error)
  } finally {
    loading.value = false
  }
}

// 5. pdfmake
const printWithPdfmake = async () => {
  currentFramework.value = 'pdfmake'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨pdfmakeç”ŸæˆPDF...'

  try {
    exportChartImages()

    // ç”Ÿæˆ2åˆ—å¸ƒå±€çš„å›¾è¡¨æ•°ç»„
    const chartRows: any[] = []
    for (let i = 0; i < chartImages.value.length; i += 2) {
      const row: any[] = [{ image: chartImages.value[i], width: 240, margin: [0, 0, 10, 0] }]
      if (i + 1 < chartImages.value.length) {
        row.push({ image: chartImages.value[i + 1], width: 240, margin: [10, 0, 0, 0] })
      }

      chartRows.push({
        columns: row,
        margin: [0, 5, 0, 15],
      })
    }

    const docDefinition: any = {
      content: [
        { text: 'å›¾è¡¨æ‰“å°æ•ˆæœæµ‹è¯• (2åˆ—å¸ƒå±€)', style: 'header', alignment: 'center' },
        {
          text: `æµ‹è¯•æ—¶é—´: ${currentDate.value} | æµ‹è¯•æ¡†æ¶: pdfmake`,
          style: 'subheader',
          alignment: 'center',
        },
        {
          canvas: [
            { type: 'line', x1: 0, y1: 5, x2: 515, y2: 5, lineWidth: 1, lineColor: '#667eea' },
          ],
        },
        { text: '\n' },
        ...chartRows,
      ],
      styles: {
        header: { fontSize: 16, bold: true, margin: [0, 0, 0, 5] },
        subheader: { fontSize: 9, color: '#718096', margin: [0, 0, 0, 10] },
      },
      footer: {
        text: 'å‰ç«¯æ‰“å°æ¡†æ¶è°ƒç ”æŠ¥å‘Š - å›¾è¡¨å¯¹æ¯”æµ‹è¯• | æµ‹è¯•é‡ç‚¹: æ£€æŸ¥æ¯è¡Œ2å›¾è¡¨çš„å¸ƒå±€',
        alignment: 'center',
        fontSize: 8,
        color: '#a0aec0',
      },
      pageMargins: [30, 30, 30, 30],
    }

    pdfMake.createPdf(docDefinition).getBlob((blob: Blob) => {
      openPrintPreview(blob)
      loading.value = false
    })
  } catch (error) {
    console.error('pdfmake error:', error)
    alert('pdfmakeç”Ÿæˆå¤±è´¥: ' + error)
    loading.value = false
  }
}

// 6. html2canvas
const printWithHtml2Canvas = async () => {
  currentFramework.value = 'html2canvas'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨html2canvasæˆªå›¾...'

  try {
    exportChartImages()
    await nextTick()

    // åˆ›å»ºä¸´æ—¶æ‰“å°å®¹å™¨
    const container = document.createElement('div')
    container.innerHTML = generatePrintHTML('html2canvas')
    container.style.position = 'absolute'
    container.style.left = '-9999px'
    container.style.width = '800px'
    container.style.background = 'white'
    document.body.appendChild(container)

    await new Promise((resolve) => setTimeout(resolve, 300))

    const canvas = await html2canvas(container, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff',
    })

    document.body.removeChild(container)

    // åˆ›å»ºæ‰“å°çª—å£
    const printHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>html2canvasæ‰“å°</title>
        <style>
          * { margin: 0; padding: 0; }
          body { display: flex; justify-content: center; padding: 10mm; }
          img { max-width: 100%; height: auto; }
          @media print { body { padding: 0; } }
        </style>
      </head>
      <body>
        <img src="${canvas.toDataURL('image/png')}">
      </body>
      </html>
    `
    const blob = new Blob([printHtml], { type: 'text/html' })
    openIframePrint(blob)
  } catch (error) {
    console.error('html2canvas error:', error)
    alert('html2canvasç”Ÿæˆå¤±è´¥: ' + error)
  } finally {
    loading.value = false
  }
}

// 7. html2pdf.js
const printWithHtml2Pdf = async () => {
  currentFramework.value = 'html2pdf.js'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨html2pdf.jsç”ŸæˆPDF...'

  try {
    const html = generatePrintHTML('html2pdf.js')
    const blob = new Blob([html], { type: 'text/html' })
    openIframePrint(blob)
  } catch (error) {
    console.error('html2pdf error:', error)
    alert('html2pdfç”Ÿæˆå¤±è´¥: ' + error)
  } finally {
    loading.value = false
  }
}

// 8. PDF-LIB
const printWithPdfLib = async () => {
  currentFramework.value = 'PDF-LIB'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨PDF-LIBç”ŸæˆPDF...'

  try {
    exportChartImages()

    const pdfDoc = await PDFDocument.create()
    let page = pdfDoc.addPage([595, 842]) // A4
    const { height } = page.getSize()

    // åµŒå…¥æ‰€æœ‰å›¾ç‰‡
    const images = []
    for (const imgData of chartImages.value) {
      const imgBytes = await fetch(imgData).then((r) => r.arrayBuffer())
      const img = await pdfDoc.embedPng(imgBytes)
      images.push(img)
    }

    // ç»˜åˆ¶å›¾ç‰‡ï¼ˆæ¯è¡Œ2ä¸ªï¼Œæ¯é¡µæœ€å¤š3è¡Œ=6ä¸ªå›¾è¡¨ï¼‰
    let y = height - 50
    const imgWidth = 260
    const imgHeight = 180
    const leftX = 30
    const rightX = 305
    const gap = 30

    // @ts-ignore - PDFImageç±»å‹æ£€æŸ¥
    for (let i = 0; i < images.length; i += 2) {
      // å·¦ä¾§å›¾è¡¨
      if (images[i]) {
        page.drawImage(images[i]!, {
          x: leftX,
          y: y - imgHeight,
          width: imgWidth,
          height: imgHeight,
        })
      }

      // å³ä¾§å›¾è¡¨
      if (i + 1 < images.length && images[i + 1]) {
        page.drawImage(images[i + 1]!, {
          x: rightX,
          y: y - imgHeight,
          width: imgWidth,
          height: imgHeight,
        })
      }

      y -= imgHeight + gap

      // æ¢é¡µï¼ˆy < 250è¡¨ç¤ºå·²ç»æ”¾äº†3è¡Œï¼Œéœ€è¦æ¢é¡µï¼‰
      if (y < 250 && i + 2 < images.length) {
        page = pdfDoc.addPage([595, 842])
        y = height - 50
      }
    }

    const pdfBytes = await pdfDoc.save()
    // @ts-ignore - pdf-lib types issue
    const blob = new Blob([pdfBytes], { type: 'application/pdf' })
    openPrintPreview(blob)
  } catch (error) {
    console.error('PDF-LIB error:', error)
    alert('PDF-LIBç”Ÿæˆå¤±è´¥: ' + error)
  } finally {
    loading.value = false
  }
}

// 9. print-html-element
const printWithPrintHtmlElement = async () => {
  currentFramework.value = 'print-html-element'
  loading.value = true
  loadingMessage.value = 'ä½¿ç”¨print-html-elementæ‰“å°...'

  try {
    const html = generatePrintHTML('print-html-element')
    const blob = new Blob([html], { type: 'text/html' })
    openIframePrint(blob)
  } catch (error) {
    console.error('print-html-element error:', error)
    alert('print-html-elementæ‰“å°å¤±è´¥: ' + error)
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
/* é¡µé¢åŸºç¡€å¸ƒå±€ï¼ˆå¤ç”¨å…¶ä»–é¡µé¢æ ·å¼ï¼‰ */
.demo-page {
  min-height: 100vh;
  background: #f7fafc;
}

.page-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.page-header h1 {
  margin: 0;
  font-size: 1.8rem;
}

.back-link {
  color: white;
  text-decoration: none;
  padding: 0.5rem 1rem;
  border: 2px solid white;
  border-radius: 4px;
  transition: all 0.3s;
}

.back-link:hover {
  background: white;
  color: #667eea;
}

.content-wrapper {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 2rem;
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

/* ä¾§è¾¹æ  */
.info-panel {
  background: white;
  border-radius: 8px;
  padding: 1.5rem;
  height: fit-content;
  position: sticky;
  top: 2rem;
}

.info-panel h2 {
  margin: 0 0 1rem 0;
  color: #2d3748;
  font-size: 1.2rem;
}

.info-section {
  margin-bottom: 1.5rem;
  padding: 1rem;
  border-radius: 6px;
  background: #f7fafc;
}

.info-section.warning {
  background: #fffbeb;
  border-left: 4px solid #f59e0b;
}

.info-section.success {
  background: #ecfdf5;
  border-left: 4px solid #10b981;
}

.info-section h3 {
  margin: 0 0 0.75rem 0;
  font-size: 1rem;
  color: #2d3748;
}

.info-section ul {
  margin: 0;
  padding-left: 1.25rem;
  font-size: 0.9rem;
  line-height: 1.8;
}

.info-section p {
  margin: 0 0 0.5rem 0;
  font-size: 0.9rem;
  color: #4a5568;
}

.info-section li {
  color: #4a5568;
  margin-bottom: 0.25rem;
}

/* ä¸»å†…å®¹åŒº */
.demo-panel {
  background: white;
  border-radius: 8px;
  padding: 2rem;
}

.chart-preview-section,
.framework-buttons {
  margin-bottom: 3rem;
}

.chart-preview-section h2,
.framework-buttons h2 {
  margin: 0 0 1rem 0;
  color: #2d3748;
  font-size: 1.5rem;
}

.button-desc {
  color: #718096;
  font-size: 0.95rem;
  margin-bottom: 1.5rem;
}

.chart-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
}

.chart-item {
  background: #f7fafc;
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.chart-container {
  width: 100%;
  height: 240px;
  background: white;
  border-radius: 4px;
}

.chart-label {
  text-align: center;
  font-weight: 600;
  color: #2d3748;
  margin: 0.75rem 0 0.25rem 0;
  font-size: 0.95rem;
}

.chart-note {
  text-align: center;
  color: #718096;
  font-size: 0.85rem;
  margin: 0;
}

/* æŒ‰é’®ç½‘æ ¼ */
.button-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 1rem;
}

.fw-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
}

.fw-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.fw-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.fw-icon {
  font-size: 1.8rem;
  margin-bottom: 0.5rem;
}

.fw-name {
  font-weight: 600;
  color: #2d3748;
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
}

.fw-size {
  font-size: 0.75rem;
  color: #a0aec0;
}

/* å„æ¡†æ¶æŒ‰é’®é¢œè‰² */
.fw-btn.native {
  border-color: #3182ce;
}
.fw-btn.native:hover:not(:disabled) {
  background: #ebf8ff;
  border-color: #2b6cb0;
}

.fw-btn.printjs {
  border-color: #d69e2e;
}
.fw-btn.printjs:hover:not(:disabled) {
  background: #fffff0;
  border-color: #b7791f;
}

.fw-btn.vueprint {
  border-color: #48bb78;
}
.fw-btn.vueprint:hover:not(:disabled) {
  background: #f0fff4;
  border-color: #38a169;
}

.fw-btn.jspdf {
  border-color: #e53e3e;
}
.fw-btn.jspdf:hover:not(:disabled) {
  background: #fff5f5;
  border-color: #c53030;
}

.fw-btn.pdfmake {
  border-color: #805ad5;
}
.fw-btn.pdfmake:hover:not(:disabled) {
  background: #faf5ff;
  border-color: #6b46c1;
}

.fw-btn.html2canvas {
  border-color: #dd6b20;
}
.fw-btn.html2canvas:hover:not(:disabled) {
  background: #fffaf0;
  border-color: #c05621;
}

.fw-btn.html2pdf {
  border-color: #38b2ac;
}
.fw-btn.html2pdf:hover:not(:disabled) {
  background: #e6fffa;
  border-color: #319795;
}

.fw-btn.pdflib {
  border-color: #667eea;
}
.fw-btn.pdflib:hover:not(:disabled) {
  background: #ebf4ff;
  border-color: #5a67d8;
}

.fw-btn.printhtmlelement {
  border-color: #ed64a6;
}
.fw-btn.printhtmlelement:hover:not(:disabled) {
  background: #fff5f7;
  border-color: #d53f8c;
}

.loading-status {
  margin-top: 1rem;
  padding: 1rem;
  background: #edf2f7;
  border-radius: 6px;
  text-align: center;
  color: #4a5568;
  font-size: 0.95rem;
}

/* éšè—çš„æ‰“å°å†…å®¹ */
.print-content-hidden {
  position: absolute;
  left: -9999px;
  top: -9999px;
  width: 210mm;
  background: white;
  padding: 20px;
}

.print-content-hidden .print-header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid #667eea;
}

.print-content-hidden .print-header h1 {
  font-size: 20px;
  color: #2d3748;
  margin: 0 0 6px 0;
}

.print-content-hidden .print-header p {
  font-size: 11px;
  color: #718096;
  margin: 0;
}

.print-content-hidden .chart-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15mm;
  margin-bottom: 15px;
}

.print-content-hidden .chart-item {
  page-break-inside: avoid;
  break-inside: avoid;
  background: #f9fafb;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
}

.print-content-hidden .chart-item h4 {
  font-size: 12px;
  color: #2d3748;
  margin: 0 0 8px 0;
  text-align: center;
}

.print-content-hidden .chart-item img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  display: block;
}

.print-content-hidden .print-footer {
  text-align: center;
  margin-top: 20px;
  padding-top: 12px;
  border-top: 1px solid #e2e8f0;
  font-size: 9px;
  color: #a0aec0;
}

/* æ‰“å°åª’ä½“æŸ¥è¯¢å·²ç§»é™¤ï¼Œæ”¹ç”¨iframeæ‰“å°æ–¹å¼ */
</style>
